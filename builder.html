<div class="row vdivide">
    <div class="col-md-4">
        {{adminltetags.useTag('fields',
            [
                'component'                                 : component,
                'componentName'                             : componentName,
                'componentId'                               : componentId,
                'sectionId'                                 : sectionId,
                'fieldId'                                   : 'accounts_structure',
                'fieldLabel'                                : 'Accounts Structure',
                'fieldType'                                 : 'jstree',
                'fieldHelp'                                 : true,
                'fieldHelpTooltipContent'                   : 'Accounts Structure. Select account item to change account properties.',
                'fieldRequired'                             : false,
                'fieldBazScan'                              : true,
                'fieldJstreeSearch'                         : true,
                'fieldBazPostOnCreate'                      : false,
                'fieldBazPostOnUpdate'                      : false,
                'fieldJstreeDataSrcArr'                     : ["accounts":["srcArr" : accountsStructure]],
                'fieldJstreeAdd'                            : false,
                'fieldJstreeEdit'                           : false,
                'fieldJstreeExpand'                         : true,
                'fieldJstreeCollapse'                       : true,
                'fieldJstreeFirstOpen'                      : true,
                'fieldJstreeAllOpen'                        : true,
                'fieldJstreeToggleAllChildren'              : true,
                'fieldJstreeIncludeRootInPath'              : false,
                'fieldJstreeSelectEndNodeOnly'              : false,
                'fieldJstreeShowDots'                       : true,
                'fieldJstreeDoubleClickToggle'              : true,
                'fieldJstreeMultiple'                       : false,
                'fieldJstreeSearchCaseSensitive'            : false,
                'fieldJstreeSearchShowOnlyMatches'          : false,
                'fieldJstreeSearchShowOnlyMatchesChildren'  : false,
                'fieldJstreeHideJstreeIcons'                : false,
                'fieldJstreeAdditionalClass'                : 'text-uppercase'
            ]
        )}}
    </div>
    <div class="col">
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('buttons',
                    [
                        'componentId'           : componentId,
                        'sectionId'             : sectionId,
                        'buttonType'            : 'button',
                        'buttons'               :
                            [
                                'add-account-item' : [
                                    'title'                   : 'Account',
                                    'size'                    : 'xs',
                                    'type'                    : 'primary',
                                    'position'                : 'right',
                                    'icon'                    : 'plus',
                                    'url'                     : '#'
                                ]
                            ]
                    ]
                )}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'account_id',
                        'fieldLabel'                     : 'Account Id',
                        'fieldType'                      : 'input',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Account Id',
                        'fieldRequired'                  : true,
                        'fieldBazScan'                   : true,
                        'fieldBazJstreeSearch'           : false,
                        'fieldBazPostOnCreate'           : false,
                        'fieldBazPostOnUpdate'           : false,
                        'fieldDataInputMinLength'        : 1,
                        'fieldDataInputMaxLength'        : 50,
                        'fieldValue'                     : '',
                        'fieldDisabled'                  : true,
                        'fieldHidden'                    : true
                    ]
                )}}
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'account_name',
                        'fieldLabel'                     : 'Name',
                        'fieldType'                      : 'input',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Account name',
                        'fieldRequired'                  : true,
                        'fieldBazScan'                   : true,
                        'fieldBazJstreeSearch'           : false,
                        'fieldBazPostOnCreate'           : false,
                        'fieldBazPostOnUpdate'           : false,
                        'fieldDataInputMinLength'        : 1,
                        'fieldDataInputMaxLength'        : 50,
                        'fieldValue'                     : '',
                        'fieldDisabled'                  : true
                    ]
                )}}
            </div>
            <div class="col">
                <div class="row">
                    <div class="col-md-10">
                        {% include '../../common/fontawesome.html' %}
                        {{adminltetags.useTag('fields',
                            [
                                'component'                      : component,
                                'componentName'                  : componentName,
                                'componentId'                    : componentId,
                                'sectionId'                      : sectionId,
                                'fieldId'                        : 'account_icon',
                                'fieldLabel'                     : 'Icon',
                                'fieldType'                      : 'select2',
                                'fieldHelp'                      : true,
                                'fieldHelpTooltipContent'        : 'Account Item Icon',
                                'fieldBazScan'                   : true,
                                'fieldBazJstreeSearch'           : false,
                                'fieldBazPostOnCreate'           : false,
                                'fieldBazPostOnUpdate'           : false,
                                'fieldRequired'                  : false,
                                'fieldDisabled'                  : true,
                                'fieldDataSelect2Options'        : fontawesomeIcons,
                                'fieldDataSelect2OptionsKey'     : 'id',
                                'fieldDataSelect2OptionsValue'   : 'text',
                                'fieldDataSelect2OptionsArray'   : true,
                                'fieldDataSelect2OptionsSelected': ''
                            ]
                        )}}
                    </div>
                    <div class="col">
                        {{adminltetags.useTag('fields',
                            [
                                'component'                      : component,
                                'componentName'                  : componentName,
                                'componentId'                    : componentId,
                                'sectionId'                      : sectionId,
                                'fieldId'                        : 'account_icon_display',
                                'fieldLabel'                     : false,
                                'fieldType'                      : 'html',
                                'fieldAdditionalClass'           : 'mb-0',
                                'fieldHelp'                      : false,
                                'fieldHelpTooltipContent'        : 'Components are building blocks of an app. Each component together with their backend packages performs a specific task.',
                                'fieldRequired'                  : false,
                                'fieldBazJstreeSearch'           : false,
                                'fieldBazScan'                   : false,
                                'fieldBazPostOnCreate'           : false,
                                'fieldBazPostOnUpdate'           : false
                            ]
                        )}}
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'account_parent',
                        'fieldLabel'                     : 'Parent',
                        'fieldType'                      : 'select2',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Account Parent',
                        'fieldBazScan'                   : true,
                        'fieldBazJstreeSearch'           : false,
                        'fieldBazPostOnCreate'           : false,
                        'fieldBazPostOnUpdate'           : false,
                        'fieldRequired'                  : true,
                        'fieldDisabled'                  : true,
                        'fieldDataSelect2Options'        : [],
                        'fieldDataSelect2OptionsKey'     : 'id',
                        'fieldDataSelect2OptionsValue'   : 'text',
                        'fieldDataSelect2OptionsArray'   : true,
                        'fieldDataSelect2OptionsSelected': ''
                    ]
                )}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'account_type',
                        'fieldLabel'                     : 'Account Type',
                        'fieldType'                      : 'select2',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Account Type',
                        'fieldBazScan'                   : true,
                        'fieldBazJstreeSearch'           : false,
                        'fieldBazPostOnCreate'           : false,
                        'fieldBazPostOnUpdate'           : false,
                        'fieldRequired'                  : true,
                        'fieldDisabled'                  : true,
                        'fieldDataSelect2Options'        : acTypes,
                        'fieldDataSelect2OptionsKey'     : 'id',
                        'fieldDataSelect2OptionsValue'   : 'name',
                        'fieldDataSelect2OptionsArray'   : true,
                        'fieldDataSelect2OptionsSelected': ''
                    ]
                )}}
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'type_description',
                        'fieldLabel'                     : false,
                        'fieldType'                      : 'html',
                        'fieldHelp'                      : false,
                        'fieldHelpTooltipContent'        : '',
                        'fieldBazJstreeSearch'           : false,
                        'fieldBazScan'                   : false,
                        'fieldHtmlContent'               : '<small id="type-description" class="text-info" hidden></small>'
                    ]
                )}}
            </div>
            <div class="col" id="banks" hidden>
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'bank_id',
                        'fieldLabel'                     : 'Bank',
                        'fieldType'                      : 'select2',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Select Bank',
                        'fieldBazScan'                   : true,
                        'fieldBazJstreeSearch'           : false,
                        'fieldBazPostOnCreate'           : false,
                        'fieldBazPostOnUpdate'           : false,
                        'fieldRequired'                  : true,
                        'fieldDisabled'                  : true,
                        'fieldDataSelect2Options'        : banks,
                        'fieldDataSelect2OptionsKey'     : 'id',
                        'fieldDataSelect2OptionsValue'   : 'name',
                        'fieldDataSelect2OptionsArray'   : true,
                        'fieldDataSelect2OptionsSelected': ''
                    ]
                )}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'account_description',
                        'fieldLabel'                     : 'Description',
                        'fieldType'                      : 'input',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Account Description.',
                        'fieldRequired'                  : false,
                        'fieldDisabled'                  : true,
                        'fieldBazScan'                   : true,
                        'fieldBazJstreeSearch'           : false,
                        'fieldBazPostOnCreate'           : false,
                        'fieldBazPostOnUpdate'           : false,
                        'fieldDataInputMinLength'        : 1,
                        'fieldDataInputMaxLength'        : 50,
                        'fieldValue'                     : ''
                    ]
                )}}
            </div>
        </div>
        <div class="row">
            <div class="col mt-4">
                {{adminltetags.useTag('buttons',
                    [
                        'componentId'           : componentId,
                        'sectionId'             : sectionId,
                        'buttonType'            : 'button',
                        'buttons'               :
                            [
                                'save-account-item' : [
                                    'title'                   : 'Save',
                                    'size'                    : 'xs',
                                    'type'                    : 'primary',
                                    'position'                : 'right',
                                    'icon'                    : 'floppy-disk',
                                    'url'                     : '#',
                                    'disabled'                : true
                                ],
                                'cancel-account-item' : [
                                    'title'                   : 'Cancel',
                                    'size'                    : 'xs',
                                    'type'                    : 'danger',
                                    'position'                : 'right',
                                    'icon'                    : 'times',
                                    'url'                     : '#',
                                    'disabled'                : true
                                ],
                                'delete-account-item' : [
                                    'title'                   : 'Account',
                                    'size'                    : 'xs',
                                    'type'                    : 'danger',
                                    'position'                : 'right',
                                    'icon'                    : 'trash',
                                    'url'                     : '#',
                                    'disabled'                : true
                                ]
                            ]
                    ]
                )}}
            </div>
        </div>
    </div>
</div>
<div class="row mt-2">
    <div class="col">
        <h6><i class="fa fa-fw fa-info-circle text-info"></i> Select account to edit or add a new account. Drag and drop account to change sequence or assign to a new parent account.</h6>
    </div>
</div>
<hr>
{% set accountsStructure = json_encode(accountsStructure, 16) %}
<script>
/* globals Sortable BazHelpers BazContentFields paginatedPNotify Swal */
var dataCollectionComponent, dataCollectionSection, dataCollectionSectionForm;

if (!window['dataCollection']['{{componentId}}']) {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'] = { };
} else {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'];
}
if (!dataCollectionComponent['{{componentId}}-{{sectionId}}']) {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'] = { };
} else {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'];
}
if (!dataCollectionSection['{{componentId}}-{{sectionId}}-form']) {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'] = { };
} else {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'];
}

dataCollectionSection =
    $.extend(dataCollectionSection, {
        '{{componentId}}-{{sectionId}}-account_id'              : { },
        '{{componentId}}-{{sectionId}}-account_name'            : { },
        '{{componentId}}-{{sectionId}}-account_type'            : {
            'placeholder'   : 'SELECT ACCOUNT TYPE'
        },
        '{{componentId}}-{{sectionId}}-bank_id'                 : {
            'placeholder'   : 'SELECT BANK'
        },
        '{{componentId}}-{{sectionId}}-account_parent'          : {
            'placeholder'   : 'SELECT PARENT'
        },
        '{{componentId}}-{{sectionId}}-account_icon'            : {
            'placeholder'   : 'SELECT ICON'
        },
        '{{componentId}}-{{sectionId}}-account_description'     : { }
    });

dataCollectionSection =
    $.extend(dataCollectionSection['{{componentId}}-{{sectionId}}-accounts_structure'], {
        afterInit: function() {
            var accountsStructure = JSON.parse('{{accountsStructure}}');

            var swalSound = window['dataCollection'].env.sounds.swalSound;

            function showNullTreeDiv() {
                var nullTree = true;

                $('#{{componentId}}-{{sectionId}}-accounts_structure li.jstree-node').filter(function(index, el) {
                    if (!$(el).hasClass('jstree-hidden')) {
                        nullTree = false;
                        return;
                    }
                });

                if ($('#{{componentId}}-{{sectionId}}-accounts_structure-empty').length > 0) {
                    $('#{{componentId}}-{{sectionId}}-accounts_structure-empty').remove();
                }

                if (nullTree) {
                    $('#{{componentId}}-{{sectionId}}-accounts_structure').prepend(
                        '<div id="{{componentId}}-{{sectionId}}-accounts_structure-empty">' +
                            '<h7><i class="fa fa-fw fa-info-circle text-info"></i> Add account via add account button.</h7>' +
                        '</div>'
                    );
                    $('#{{componentId}}-{{sectionId}}-accounts_structure-tree-empty').attr('hidden', false);
                } else {
                    $('#{{componentId}}-{{sectionId}}-accounts_structure-tree-empty').attr('hidden', true);
                }
            }

            showNullTreeDiv();

            function extractSturctureData(structureArr) {
                var newStructure = { };

                for (var structure in structureArr) {
                    var structureId;
                    structureId = structureArr[structure]['data']['uuid'];

                    if (!newStructure[structureId]) {
                        newStructure[structureId] = { };
                    }

                    newStructure[structureId]['title'] = structureArr[structure]['text'];

                    var iconArr = structureArr[structure]['icon'].split(' ');
                    if (iconArr.length > 0) {
                        iconArr.forEach(function(v, i) {
                            if (v !== 'fa' && v !== 'fa-fw' && v.startsWith("fa-")) {
                                newStructure[structureId]['icon'] = v.replace("fa-", "");
                            }
                        });
                    } else {
                        newStructure[structureId]['icon'] = "circle";
                    }

                    newStructure[structureId]['data'] = { };
                    newStructure[structureId]['data']['uuid'] = structureArr[structure]['data']['uuid'];
                    newStructure[structureId]['data']['description'] = structureArr[structure]['data']['description'];
                    newStructure[structureId]['data']['type'] = structureArr[structure]['data']['type'];
                    if (structureArr[structure]['data']['bank_id']) {
                        newStructure[structureId]['data']['bank_id'] = structureArr[structure]['data']['bank_id'];
                    }

                    newStructure[structureId]['seq'] = parseInt(structure);

                    if (structureArr[structure]['children'].length > 0) {
                        newStructure[structureId]['childs'] = { };

                        var childs = { };

                        for (var child in structureArr[structure]['children']) {
                            childs[child] = structureArr[structure]['children'][child];
                        }
                        newStructure[structureId]['childs'] = extractSturctureData(childs);
                    }
                }

                return newStructure;
            }

            function extractSturctureParentsData(selectParent = '', selectedNode = '') {
                var menuItemsParents = [];
                var structureArr = $("#{{componentId}}-{{sectionId}}-accounts_structure").jstree().get_json('#', { 'flat': true });
                var parentItem = { };

                parentItem['id'] = '#';
                parentItem['text'] = 'ROOT';

                menuItemsParents.push(parentItem);

                for (var structure in structureArr) {
                    if (structureArr[structure]['id'] !== selectedNode) {
                        parentItem = { };
                        parentItem['id'] = structureArr[structure]['id'];
                        parentItem['text'] = $("#{{componentId}}-{{sectionId}}-accounts_structure").jstree().get_path(structureArr[structure]['id'], ' > ').toUpperCase();

                        menuItemsParents.push(parentItem);
                    }
                }

                $('#{{componentId}}-{{sectionId}}-account_parent')
                    .select2().empty()
                    .select2({data: menuItemsParents})
                    .select2({"placeholder" : "SELECT PARENT"}).val(selectParent).trigger('change');
            }

            function getAccountsStructureData(parent = null) {
                window['dataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}']['data']['accounts_structure'] =
                    extractSturctureData($('#{{componentId}}-{{sectionId}}-accounts_structure').jstree().get_json());

                extractSturctureParentsData();
                showNullTreeDiv();
                prettyfyJson();
            }

            getAccountsStructureData();

            $(document).on('dnd_stop.vakata', function (e, data) {
                moveNode(
                    data.data.nodes[0],
                    $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree().get_parent(data.data.nodes[0]),
                    $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree().get_node(data.data.nodes[0]),
                    $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree().get_children_dom(data.data.nodes[0])
                );

                extractSturctureParentsData();
                getAccountsStructureData();
                cleanMenuForm();
            });

            $('#{{componentId}}-{{sectionId}}-accounts_structure').on('create_node.jstree', function (e, data) {
                getAccountsStructureData();
            });
            $('#{{componentId}}-{{sectionId}}-accounts_structure').on('rename_node.jstree', function (e, data) {
                getAccountsStructureData();
            });
            $('#{{componentId}}-{{sectionId}}-accounts_structure').on('select_node.jstree', function (e, data) {
                $('#{{componentId}}-{{sectionId}}-account_id').val(data.node.id);
                $('#{{componentId}}-{{sectionId}}-account_name').val(data.node.text);

                var iconArr = data.node.icon.split(' ');
                if (iconArr.length > 0) {
                    iconArr.forEach(function(v, i) {
                        if (v !== 'fa' && v !== 'fa-fw' && v !== 'fab' && v.startsWith("fa-")) {
                            $('#{{componentId}}-{{sectionId}}-account_icon').val(v.replace("fa-", "")).trigger('change');
                        }
                    });
                    $('#{{componentId}}-{{sectionId}}-account_icon_display').empty().append(
                        '<i style="margin-top:1.9rem !important;" class="' + data.node.icon + '"></i>'
                    );
                    $('#{{componentId}}-{{sectionId}}-account_icon_display').children('i').removeClass('text-sm').addClass('fa-2x');
                } else {
                    $('#{{componentId}}-{{sectionId}}-account_icon').val("circle").trigger('change');
                    $('#{{componentId}}-{{sectionId}}-account_icon_display').empty().append(
                        '<i style="margin-top:1.9rem !important;" class="fa fa-fw fa-2x fa-circle"></i>'
                    );
                }

                $('#{{componentId}}-{{sectionId}}-account_description').val(data.node.data.description);
                $('#{{componentId}}-{{sectionId}}-account_type').val(data.node.data.type).trigger('change');
                if (data.node.data.bank_id) {
                    $('#{{componentId}}-{{sectionId}}-bank_id').val(data.node.data.bank_id).trigger('change');
                } else {
                    $('#{{componentId}}-{{sectionId}}-bank_id').val(0).trigger('change');
                }
                $('#type-description').html(
                    '<i class="fa-solid fa-circle-info"></i> ' +
                    $($('#{{componentId}}-{{sectionId}}-account_type')
                      .find('[data-value="' + data.node.data.type + '"]'))
                    .data('description')
                );
                $('#type-description').attr('hidden', false);
                $('#{{componentId}}-{{sectionId}}-account_type').attr('disabled', false);
                if (data.node.data.type === 'bank') {
                    $('#{{componentId}}-{{sectionId}}-bank_id').attr('disabled', false);
                    $('#banks').attr('hidden', false);
                } else {
                    $('#{{componentId}}-{{sectionId}}-bank_id').attr('disabled', true);
                    $('#banks').attr('hidden', true);
                }
                $('#{{componentId}}-{{sectionId}}-account_name').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-account_icon').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-account_description').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-save-account-item').removeClass('disabled');
                $('#{{componentId}}-{{sectionId}}-cancel-account-item').removeClass('disabled');
                $('#{{componentId}}-{{sectionId}}-delete-account-item').removeClass('disabled');
                $('#{{componentId}}-{{sectionId}}-account_parent').attr('disabled', false);

                extractSturctureParentsData(data.node.parent, data.node.id);
            });

            $('#{{componentId}}-{{sectionId}}-account_icon').on('select2:select', function(e) {
                var iconDisplay = document.querySelectorAll('.fa-' + e.params.data.id);
                var iconType = $(e.params.data.element).data('type');
                var isBrand = '';

                if (iconType === 'brands') {
                    isBrand = 'fab';
                }

                $('#{{componentId}}-{{sectionId}}-account_icon_display').empty().append(
                    '<i style="margin-top:1.9rem !important;" class="fa ' + isBrand + ' fa-fw fa-2x fa-' + e.params.data.id + '"></i>'
                );
            });

            $('#{{componentId}}-{{sectionId}}-account_type').on('select2:select', function(e) {
                $('#type-description').html('<i class="fa-solid fa-circle-info"></i> ' + $(e.params.data.element).data('description'));
                $('#type-description').attr('hidden', false);

                if (e.params.data.id === 'bank') {
                    $('#banks').attr('hidden', false);
                } else {
                    $('#banks').attr('hidden', true);
                }
            });

            $('#{{componentId}}-{{sectionId}}-add-account-item').click(function(e) {
                e.preventDefault();
                cleanMenuForm();

                $('#{{componentId}}-{{sectionId}}-account_name').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-account_parent').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-account_type').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-bank_id').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-account_icon').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-account_icon').val('circle').trigger('change');
                $('#{{componentId}}-{{sectionId}}-account_description').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-save-account-item').removeClass('disabled');
                $('#{{componentId}}-{{sectionId}}-cancel-account-item').removeClass('disabled');
                extractSturctureParentsData('#');
                $('#{{componentId}}-{{sectionId}}-account_icon_display').empty().append(
                    '<i style="margin-top:1.9rem !important;" class="fa fa-fw fa-2x fa-circle"></i>'
                );
            });

            $('#{{componentId}}-{{sectionId}}-delete-account-item').click(function(e) {
                e.preventDefault();

                var accountName = $('#{{componentId}}-{{sectionId}}-account_name').val();

                Swal.fire({
                    title                       : '<span class="text-danger"> Remove account ' + accountName + '?</span>',
                    icon                        : 'question',
                    background                  : 'rgba(0,0,0,.8)',
                    backdrop                    : 'rgba(0,0,0,.6)',
                    buttonsStyling              : false,
                    confirmButtonText           : 'Delete',
                    customClass                 : {
                        'confirmButton'             : 'btn btn-danger text-uppercase',
                        'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
                    },
                    showCancelButton            : true,
                    keydownListenerCapture      : true,
                    allowOutsideClick           : true,
                    allowEscapeKey              : true,
                    didOpen                     : function() {
                        swalSound.play();
                    }
                }).then((result) => {
                    if (result.value) {
                        var selectedNode = $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree().get_selected(true);

                        if (selectedNode[0].children.length > 0) {
                            paginatedPNotify('notice', {
                                title: 'Account cannot be remove as it has sub accounts. Delete sub accounts first.'
                            });
                        } else {
                            var selectedNodeId = selectedNode[0].id;

                            var deleteNode = $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree().delete_node(selectedNodeId);

                            if (deleteNode) {
                                cleanMenuForm();
                                getAccountsStructureData();
                            }
                        }
                    }
                });
            });

            function cleanMenuForm() {
                $('#{{componentId}}-{{sectionId}}-account_id').val('');
                $('#{{componentId}}-{{sectionId}}-account_name').val('');
                $('#{{componentId}}-{{sectionId}}-account_name').attr('disabled', true);
                $('#{{componentId}}-{{sectionId}}-account_parent').attr('disabled', true);
                $('#{{componentId}}-{{sectionId}}-account_parent').empty().trigger('change');
                $('#{{componentId}}-{{sectionId}}-account_type').attr('disabled', true);
                $('#{{componentId}}-{{sectionId}}-account_type').val('').trigger('change');
                $('#{{componentId}}-{{sectionId}}-bank_id').attr('disabled', true);
                $('#{{componentId}}-{{sectionId}}-bank_id').val('').trigger('change');
                $('#banks').attr('hidden', true);
                $('#type-description').html('');
                $('#type-description').attr('hidden', true);
                $('#{{componentId}}-{{sectionId}}-account_icon').attr('disabled', true);
                $('#{{componentId}}-{{sectionId}}-account_icon').val('').trigger('change');
                $('#{{componentId}}-{{sectionId}}-account_icon_display').empty();
                $('#{{componentId}}-{{sectionId}}-account_description').attr('disabled', true);
                $('#{{componentId}}-{{sectionId}}-account_description').val('');
                $('#{{componentId}}-{{sectionId}}-save-account-item').addClass('disabled');
                $('#{{componentId}}-{{sectionId}}-cancel-account-item').addClass('disabled');
                $('#{{componentId}}-{{sectionId}}-delete-account-item').addClass('disabled');
                $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree().deselect_all();
                $('#{{componentId}}-{{sectionId}}-account_parent')
                    .select2().empty()
                    .select2({"placeholder" : "SELECT PARENT"}).val('').trigger('change');
            }

            $('#{{componentId}}-{{sectionId}}-save-account-item, #{{componentId}}-{{sectionId}}-cancel-account-item').click(function(e) {
                e.preventDefault();

                var id = $(this)[0].id;

                if (id === "{{componentId}}-{{sectionId}}-cancel-account-item") {
                    cleanMenuForm();
                }

                if (id === "{{componentId}}-{{sectionId}}-save-account-item") {
                    if ($('#{{componentId}}-{{sectionId}}-account_name').val() === '') {
                        $('#{{componentId}}-{{sectionId}}-account_name').addClass('is-invalid');
                        $('#{{componentId}}-{{sectionId}}-account_name').focus(function() {
                            $(this).removeClass('is-invalid');
                        });
                    } else {
                        var nodeId, nodeData, name, isPlaceholder, accountType, bankId, parentId, parent, icon, iconId, iconType, isBrand, description;

                        nodeId = $('#{{componentId}}-{{sectionId}}-account_id').val();
                        parentId = $('#{{componentId}}-{{sectionId}}-account_parent').select2('data')[0].id;
                        parent = $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree().get_node(parentId);
                        name = $('#{{componentId}}-{{sectionId}}-account_name').val();
                        accountType = $('#{{componentId}}-{{sectionId}}-account_type').select2('data')[0].id;
                        if (accountType === 'bank') {
                            bankId = $('#{{componentId}}-{{sectionId}}-bank_id').select2('data')[0].id;
                        }
                        icon = $('#{{componentId}}-{{sectionId}}-account_icon').select2('data');
                        iconId = $('#{{componentId}}-{{sectionId}}-account_icon').select2('data')[0].id;
                        iconType = $(icon[0].element).data('type');
                        description = $('#{{componentId}}-{{sectionId}}-account_description').val();

                        if (iconType === 'brands') {
                            isBrand = 'fab';
                        } else {
                            isBrand = 'fa';
                        }

                        if (nodeId !== '') {//Edit Account
                            nodeData = $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree().get_node(nodeId);

                            if (!nodeData['data']) {
                                nodeData['data'] = { };
                            }

                            if (checkDuplicate(nodeId, parent, name)) {
                                paginatedPNotify('notice', {
                                    title: 'Duplicate title!'
                                });
                                return;
                            }

                            if (nodeData['text'] !== name) {
                                $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree('rename_node', nodeId, name);
                                nodeData['data']['renamed'] = true;
                            }

                            var newIcon = isBrand + ' fa-fw fa-' + iconId + ' text-sm';
                            if (nodeData['icon'] !== newIcon) {
                                $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree('set_icon', nodeId, newIcon);
                            }

                            nodeData['data']['description'] = description;
                            nodeData['data']['type'] = accountType;
                            if (bankId) {
                                nodeData['data']['bank_id'] = bankId;
                            }

                            if (nodeData['parent'] !== parentId) {
                                moveNode(nodeId, parentId, nodeData);
                            }

                            getAccountsStructureData();
                            cleanMenuForm();
                        } else {//New Account
                            if (checkDuplicate(nodeId, parent, name)) {
                                paginatedPNotify('notice', {
                                    title: 'Duplicate title!'
                                });

                                return;
                            }

                            var postData = { };
                            postData[$('#security-token').attr('name')] = $('#security-token').val();

                            $.post('{{links.url("accounting/tools/accountshierarchies/getNewAccountUUID")}}', postData, function(response) {
                                if (response.tokenKey && response.token) {
                                    $("#security-token").attr("name", response.tokenKey);
                                    $("#security-token").val(response.token);
                                }

                                $('#{{componentId}}-{{sectionId}}-account_id').val(response.responseData.uuid);

                                var data = { };
                                data['description'] = description;
                                data['type'] = accountType;
                                if (bankId) {
                                    data['bank_id'] = bankId;
                                }
                                data['uuid'] = $('#{{componentId}}-{{sectionId}}-account_id').val();

                                $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree('create_node',
                                    parentId,
                                    {'text' : name, 'icon' : isBrand + ' fa-fw fa-' + iconId + ' text-sm', 'data' : data},
                                    'last',
                                    function() {
                                        cleanMenuForm();
                                    }
                                );
                            }, 'json');
                        }
                    }
                }
            });

            function moveNode(nodeId, parentId, nodeData, children = null) {
                $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree('move_node',
                    nodeId,
                    parentId,
                    'last',
                    function() {
                        nodeData['data']['moved'] = true;

                        if (children && children.length > 0) {
                            for (var child in children) {
                                if (children[child].nodeName === 'LI') {
                                    parentId = $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree().get_parent(children[child].id);
                                    nodeData = $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree().get_node(children[child].id);

                                    $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree('move_node',
                                        children[child].id,
                                        parentId,
                                        'last',
                                        function() {
                                            nodeData['data']['moved'] = true;
                                        }
                                    );
                                }
                            }
                        }
                });
            }

            function checkDuplicate(nodeId, parent, title) {
                if (parent['children'] && parent['children'].length > 0) {
                    for (var children in parent['children']) {
                        if (parent['children'][children] !== nodeId) {
                            var child = $('#{{componentId}}-{{sectionId}}-accounts_structure').jstree().get_node(parent['children'][children]);

                            if (child['text'].toLowerCase() === title.toLowerCase()) {
                                return true;
                            }
                        }
                    }
                }

                return false;
            }

            function prettyfyJson() {
                $('#{{componentId}}-{{sectionId}}-hierarchy').
                    val(
                        JSON.stringify(
                            window['dataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}']['data']['accounts_structure'], null, 4
                        )
                    );
            }

            prettyfyJson();
        },
        'core' : $.extend(dataCollectionSection['{{componentId}}-{{sectionId}}-accounts_structure']['core'], {
            check_callback : function (operation, node, node_parent, node_position, more) {
                if (operation === 'move_node') {
                    if (node_parent['id'] !== '#') {
                        if (node_parent['data']['type'] === 'placeholder') {
                            return false;
                        }
                    }
                }
            }
        })
    });
</script>